import hancho
import glob

metron_lib = imports.rules.cpp_lib(
  name    = "metron_lib",
  in_srcs = glob.glob("*.cpp") + glob.glob("nodes/*.cpp"),
  out_lib = "libmetron.a"
)


metron_bin = imports.rules.cpp_bin(
  name    = "metron_bin",
  in_srcs = glob.glob("main/*.cpp"),
  in_objs = [metron_lib, imports.metrolib.libcore],
  out_bin = "metron",
)

exports.convert = hancho.Config(
  command = "{in_binary} -q -v -e -c {rel(in_src)} -o {rel(out_sv)}",
  in_binary = metron_bin,
  out_sv = "{swap_ext(in_src, '.sv')}",
)

exports.metron_lib = metron_lib
exports.metron_bin = metron_bin


"""
################################################################################
# Emscripten

build docs/demo/examples.data: run_command tests/metron/fail/basic_reg_rwr.h tests/metron/fail/basic_sig_wrw.h tests/metron/fail/bowtied_signals.h tests/metron/fail/case_without_break.h tests/metron/fail/func_writes_sig_and_reg.h tests/metron/fail/if_with_no_compound.h tests/metron/fail/mid_block_break.h tests/metron/fail/mid_block_return.h tests/metron/fail/multiple_submod_function_bindings.h tests/metron/fail/multiple_tock_returns.h tests/metron/fail/tick_with_return_value.h tests/metron/fail/unorderable_ticks.h tests/metron/fail/unorderable_tocks.h tests/metron/fail/wrong_submod_call_order.h tests/metron/pass/all_func_types.h tests/metron/pass/basic_constructor.h tests/metron/pass/basic_function.h tests/metron/pass/basic_increment.h tests/metron/pass/basic_inputs.h tests/metron/pass/basic_literals.h tests/metron/pass/basic_localparam.h tests/metron/pass/basic_output.h tests/metron/pass/basic_param.h tests/metron/pass/basic_public_reg.h tests/metron/pass/basic_public_sig.h tests/metron/pass/basic_reg_rww.h tests/metron/pass/basic_sig_wwr.h tests/metron/pass/basic_submod.h tests/metron/pass/basic_submod_param.h tests/metron/pass/basic_submod_public_reg.h tests/metron/pass/basic_switch.h tests/metron/pass/basic_task.h tests/metron/pass/basic_template.h tests/metron/pass/bit_casts.h tests/metron/pass/bit_concat.h tests/metron/pass/bit_dup.h tests/metron/pass/bitfields.h tests/metron/pass/both_tock_and_tick_use_tasks_and_funcs.h tests/metron/pass/builtins.h tests/metron/pass/call_tick_from_tock.h tests/metron/pass/case_with_fallthrough.h tests/metron/pass/constructor_arg_passing.h tests/metron/pass/constructor_args.h tests/metron/pass/counter.h tests/metron/pass/defines.h tests/metron/pass/dontcare.h tests/metron/pass/enum_simple.h tests/metron/pass/for_loops.h tests/metron/pass/good_order.h tests/metron/pass/if_with_compound.h tests/metron/pass/include_guards.h tests/metron/pass/include_test_module.h tests/metron/pass/include_test_submod.h tests/metron/pass/init_chain.h tests/metron/pass/initialize_struct_to_zero.h tests/metron/pass/input_signals.h tests/metron/pass/local_localparam.h tests/metron/pass/magic_comments.h tests/metron/pass/matching_port_and_arg_names.h tests/metron/pass/minimal.h tests/metron/pass/multi_tick.h tests/metron/pass/namespaces.h tests/metron/pass/nested_structs.h tests/metron/pass/nested_submod_calls.h tests/metron/pass/noconvert.h tests/metron/pass/nonblocking_assign_to_struct_union.h tests/metron/pass/oneliners.h tests/metron/pass/plus_equals.h tests/metron/pass/preproc.h tests/metron/pass/private_getter.h tests/metron/pass/self_reference.h tests/metron/pass/slice.h tests/metron/pass/structs.h tests/metron/pass/structs_as_args.h tests/metron/pass/structs_as_ports.h tests/metron/pass/submod_bindings.h tests/metron/pass/tock_task.h tests/metron/pass/trivial_adder.h tests/metron/pass/unions.h tests/metron/pass/utf8-mod.bom.h tests/metron/pass/utf8-mod.h examples/gb_spu/MetroBoySPU2.h examples/ibex/ibex_alu.h examples/ibex/ibex_compressed_decoder.h examples/ibex/ibex_multdiv_slow.h examples/ibex/ibex_pkg.h examples/ibex/prim_arbiter_fixed.h examples/j1/dpram.h examples/j1/j1.h examples/picorv32/picorv32.h examples/pong/pong.h examples/rvsimple/adder.h examples/rvsimple/alu.h examples/rvsimple/alu_control.h examples/rvsimple/config.h examples/rvsimple/constants.h examples/rvsimple/control_transfer.h examples/rvsimple/data_memory_interface.h examples/rvsimple/example_data_memory.h examples/rvsimple/example_data_memory_bus.h examples/rvsimple/example_text_memory.h examples/rvsimple/example_text_memory_bus.h examples/rvsimple/immediate_generator.h examples/rvsimple/instruction_decoder.h examples/rvsimple/multiplexer2.h examples/rvsimple/multiplexer4.h examples/rvsimple/multiplexer8.h examples/rvsimple/regfile.h examples/rvsimple/register.h examples/rvsimple/riscv_core.h examples/rvsimple/singlecycle_control.h examples/rvsimple/singlecycle_ctlpath.h examples/rvsimple/singlecycle_datapath.h examples/rvsimple/toplevel.h examples/scratch.h examples/tutorial/adder.h examples/tutorial/bit_twiddling.h examples/tutorial/blockram.h examples/tutorial/checksum.h examples/tutorial/clocked_adder.h examples/tutorial/counter.h examples/tutorial/declaration_order.h examples/tutorial/functions_and_tasks.h examples/tutorial/nonblocking.h examples/tutorial/submodules.h examples/tutorial/templates.h examples/tutorial/tutorial2.h examples/tutorial/tutorial3.h examples/tutorial/tutorial4.h examples/tutorial/tutorial5.h examples/tutorial/vga.h examples/uart/uart_hello.h examples/uart/uart_rx.h examples/uart/uart_top.h examples/uart/uart_tx.h
  command = python3 $$EMSDK/upstream/emscripten/tools/file_packager.py docs/demo/examples.data --no-node --js-output=docs/demo/examples.js --preload examples tests/metron/pass tests/metron/fail --exclude *.cpp *.sv *.MD *.hex *.pcf *.v *.txt

build docs/tutorial/tutorial_src.data: run_command examples/tutorial/adder.h examples/tutorial/bit_twiddling.h examples/tutorial/blockram.h examples/tutorial/checksum.h examples/tutorial/clocked_adder.h examples/tutorial/counter.h examples/tutorial/declaration_order.h examples/tutorial/functions_and_tasks.h examples/tutorial/nonblocking.h examples/tutorial/submodules.h examples/tutorial/templates.h examples/tutorial/tutorial2.h examples/tutorial/tutorial3.h examples/tutorial/tutorial4.h examples/tutorial/tutorial5.h examples/tutorial/vga.h
  command = python3 $$EMSDK/upstream/emscripten/tools/file_packager.py docs/tutorial/tutorial_src.data --no-node --js-output=docs/tutorial/tutorial_src.js --preload examples/tutorial examples/uart/metron


################################################################################
# Compile docs/app/metron.js using ems_compile_cpp and ems_js_binary

build wasm/obj/metron/main/main.o: ems_compile_cpp metron/main/main.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/metron/main/main_new.o: ems_compile_cpp metron/main/main_new.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/metron/CContext.o: ems_compile_cpp metron/CContext.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/metron/CInstance.o: ems_compile_cpp metron/CInstance.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/metron/CLexer.o: ems_compile_cpp metron/CLexer.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/metron/CNode.o: ems_compile_cpp metron/CNode.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/metron/CParser.o: ems_compile_cpp metron/CParser.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/metron/CScope.o: ems_compile_cpp metron/CScope.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/metron/CSourceFile.o: ems_compile_cpp metron/CSourceFile.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/metron/CSourceRepo.o: ems_compile_cpp metron/CSourceRepo.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/metron/CToken.o: ems_compile_cpp metron/CToken.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/metron/Checker.o: ems_compile_cpp metron/Checker.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/metron/Cursor.o: ems_compile_cpp metron/Cursor.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/metron/Dumper.o: ems_compile_cpp metron/Dumper.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/metron/Emitter.o: ems_compile_cpp metron/Emitter.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/metron/MtUtils.o: ems_compile_cpp metron/MtUtils.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/metron/Tracer.o: ems_compile_cpp metron/Tracer.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/metron/metron_tools.o: ems_compile_cpp metron/metron_tools.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/metron/nodes/CNodeClass.o: ems_compile_cpp metron/nodes/CNodeClass.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/metron/nodes/CNodeDeclaration.o: ems_compile_cpp metron/nodes/CNodeDeclaration.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/metron/nodes/CNodeField.o: ems_compile_cpp metron/nodes/CNodeField.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/metron/nodes/CNodeFunction.o: ems_compile_cpp metron/nodes/CNodeFunction.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/metron/nodes/CNodeStruct.o: ems_compile_cpp metron/nodes/CNodeStruct.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/metron/nodes/CNodeTranslationUnit.o: ems_compile_cpp metron/nodes/CNodeTranslationUnit.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/metron/nodes/CNodeUnion.o: ems_compile_cpp metron/nodes/CNodeUnion.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/symlinks/metrolib/metrolib/core/Platform.o: ems_compile_cpp symlinks/metrolib/metrolib/core/Platform.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/symlinks/metrolib/metrolib/core/Utils.o: ems_compile_cpp symlinks/metrolib/metrolib/core/Utils.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build wasm/obj/symlinks/metrolib/metrolib/core/Err.o: ems_compile_cpp symlinks/metrolib/metrolib/core/Err.cpp
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
build docs/app/metron.js: ems_js_binary wasm/obj/metron/main/main.o wasm/obj/metron/main/main_new.o wasm/obj/metron/CContext.o wasm/obj/metron/CInstance.o wasm/obj/metron/CLexer.o wasm/obj/metron/CNode.o wasm/obj/metron/CParser.o wasm/obj/metron/CScope.o wasm/obj/metron/CSourceFile.o wasm/obj/metron/CSourceRepo.o wasm/obj/metron/CToken.o wasm/obj/metron/Checker.o wasm/obj/metron/Cursor.o wasm/obj/metron/Dumper.o wasm/obj/metron/Emitter.o wasm/obj/metron/MtUtils.o wasm/obj/metron/Tracer.o wasm/obj/metron/metron_tools.o wasm/obj/metron/nodes/CNodeClass.o wasm/obj/metron/nodes/CNodeDeclaration.o wasm/obj/metron/nodes/CNodeField.o wasm/obj/metron/nodes/CNodeFunction.o wasm/obj/metron/nodes/CNodeStruct.o wasm/obj/metron/nodes/CNodeTranslationUnit.o wasm/obj/metron/nodes/CNodeUnion.o wasm/obj/symlinks/metrolib/metrolib/core/Platform.o wasm/obj/symlinks/metrolib/metrolib/core/Utils.o wasm/obj/symlinks/metrolib/metrolib/core/Err.o
  includes = ${base_includes} -Isymlinks/CLI11/include
  libraries =
"""
