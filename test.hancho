import hancho
import glob

tests = hancho.load("tests/tests.hancho", **imports)

#---------------------------------------------------------------------------------------------------

test_helpers = hancho.Config(
  suffix_pass = "{out_pass}.temp 2>&1 &&  mv {out_pass}.temp {out_pass}",
  suffix_fail = "{out_pass}.temp 2>&1 || (mv {out_pass}.temp {out_pass} && (exit 255))",
  build_tag   = "test",
)

test_yosys_synth = test_helpers.extend(
  desc = "test yosys synth pass {rel(in_src)}",
  command = "yosys -q -p 'read_verilog {includes} -sv {rel(in_src)}; synth_ice40 -json /dev/null' > {suffix_pass}",
  includes = ["-I."],
  out_pass = "{in_src}.yosys_synth.pass",
)

test_yosys_synth_fail = test_helpers.extend(
  desc = "test yosys synth fail {rel(in_src)}",
  command = "yosys -q -p 'read_verilog {includes} -sv {rel(in_src)}; synth_ice40 -json /dev/null' > {suffix_fail}",
  includes = ["-I."],
  out_pass = "{in_src}.yosys_synth.pass",
)

test_yosys_parse = test_helpers.extend(
  desc = "test yosys parse {rel(in_src)}",
  command = "yosys -q -p 'read_verilog {includes} -sv {rel(in_src)};' > {suffix_pass}",
  includes = ["-I."],
  out_pass = "{in_src}.yosys_parse.pass",
)

test_verilator = test_helpers.extend(
  desc = "test verilator {rel(in_src)}",
  command = "verilator -Wno-width {includes} --lint-only {rel(in_src)} > {suffix_pass}",
  includes = ["-I."],
  out_pass = "{in_src}.verilator.pass",
)

test_icarus = test_helpers.extend(
  desc = "test icarus {rel(in_src)}",
  command = "iverilog -g2012 -Wall {includes} -o /dev/null {rel(in_src)} > {suffix_pass}",
  includes = ["-I."],
  out_pass = "{in_src}.icarus.pass",
)

test_syntax = test_helpers.extend(
  desc = "test c++ syntax {rel(in_src)}",
  command = "g++ -I. --std=gnu++2a -fsyntax-only -c {rel(in_src)} > {suffix_pass}",
  out_pass = "{in_src}.syntax.pass"
)

test_metron = test_helpers.extend(
  desc = "test metron {rel(in_src)}",
  command = "{metron_bin} -q -c {rel(in_src)} -o {rel(out_sv)} > {suffix_pass}",
  out_sv = "{swap_ext(in_src, '.sv')}",
  metron_bin = imports.metron.metron_bin,
  out_pass = "{in_src}.metron.pass"
)

test_metron_fail = test_helpers.extend(
  desc = "test metron fails {rel(in_src)}",
  command = "{metron_bin} -q -c {rel(in_src)} -o /dev/null > {suffix_fail}",
  metron_bin = imports.metron.metron_bin,
  out_pass = "{in_src}.metron.pass",
  should_fail = True
)

test_diff = test_helpers.extend(
  desc = "test diff {rel(in_src_A)} {rel(in_src_B)}",
  command = "diff {rel(in_src_A)} {rel(in_src_B)} > {suffix_pass}",
  out_pass = "{in_src_A}.diff.pass"
)

test_sv2v = test_helpers.extend(
  desc = "test sv2v {rel(in_src)}",
  command = "sv2v {includes} {rel(in_src)} -w {rel(out_v)} > {suffix_pass}",
  includes = ["-I."],
  out_v = "{swap_ext(in_src, '.v')}",
  out_pass = "{in_src}.sv2v.pass"
)

#---------------------------------------------------------------------------------------------------
# Test tool quirks

for file in glob.glob("tests/tools/pass/*.sv"):
  test_icarus(in_src = file)
  test_yosys_synth(in_src = file)
  test_verilator(in_src = file)

for file in glob.glob("tests/tools/yosys/fail/*.sv"):
  test_yosys_synth_fail(in_src = file, should_fail = True)

#---------------------------------------------------------------------------------------------------
# Test files in tests/metron/pass and tests/metron/fail

for file in glob.glob("tests/metron/pass/*.h"):
  includes = ["-I.", "-I{build_path}/tests/metron/pass"]

  test_syntax(in_src = file)
  file_sv = test_metron(in_src = file, should_fail = False).promise("out_sv")
  file_v  = test_sv2v(in_src = file_sv, includes = includes).promise("out_v")

  golden = file.replace("/pass/", "/golden/").replace(".h", ".sv")
  test_diff(in_src_A = file_sv, in_src_B = golden)

  test_verilator(in_src = file_sv, includes = includes)
  test_icarus(in_src = file_sv, includes = includes)
  test_yosys_synth(in_src = file_v, includes = includes)

for file in glob.glob("tests/metron/fail/*.h"):
  test_syntax(in_src = file)
  test_metron_fail(in_src = file)

#---------------------------------------------------------------------------------------------------
# Lockstep tests

def test_lockstep(file, should_fail = False):
  out_sv = test_metron(in_src = file).promise("out_sv")

  out_vl = imports.rules.verilator(
    name = "test lockstep",
    in_top = out_sv,
    includes = [],
    build_tag = "test",
  )

  lockstep_obj = hancho.Task(
    command = "g++ -O3 -std=gnu++2a {defines} {includes} -c {rel(in_src)} -o {rel(out_obj)}",
    includes = ["-I.", "-Isymlinks", "-Isymlinks/metrolib", "-I{build_path}/tests/lockstep", "-I/usr/local/share/verilator/include"],
    defines = "-DMT_TOP=Module -DVL_TOP=V{stem} -DMT_HEADER={in_hdr} -DVL_HEADER={build_path}/tests/lockstep/V{stem}.h",
    in_src  = "tests/lockstep/test_lockstep.cpp",
    in_hdr  = file,
    in_deps = out_vl.promise("out_header"),
    out_obj = "{swap_ext(in_hdr, '.o')}",
    stem    = "{path.splitext(path.basename(in_hdr))[0]}",
    build_tag = "test",
  )

  lockstep_bin = hancho.Task(
    command = "g++ {in_obj} {in_lib} -o {rel(out_bin)}",
    in_obj = lockstep_obj.promise("out_obj"),
    in_lib = [out_vl.promise("out_lib"), imports.metrolib.libcore],
    out_bin = "{swap_ext(in_obj, '')}",
    build_tag = "test",
  )

  if should_fail:
    hancho.Task(
      command  = "{in_bin} > {out_pass}.temp 2>&1 || (mv {out_pass}.temp {out_pass} && (exit 255))",
      in_bin   = lockstep_bin.promise("out_bin"),
      out_pass = "{in_bin}.pass",
      should_fail = should_fail,
      build_tag = "test",
    )
  else:
    hancho.Task(
      command  = "{in_bin} > {out_pass}.temp 2>&1 && mv {out_pass}.temp {out_pass}",
      in_bin   = lockstep_bin.promise("out_bin"),
      out_pass = "{in_bin}.pass",
      should_fail = should_fail,
      build_tag = "test",
    )

for file in ["tests/lockstep/lfsr.h", "tests/lockstep/counter.h", "tests/lockstep/funcs_and_tasks.h"]:
  test_lockstep(file, should_fail = False)

for file in ["tests/lockstep/timeout_bad.h", "tests/lockstep/lockstep_bad.h"]:
  test_lockstep(file, should_fail = True)

#---------------------------------------------------------------------------------------------------
