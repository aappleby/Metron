import hancho
import glob

#---------------------------------------------------------------------------------------------------

test_logic = imports.rules.cpp_bin(
  name    = "utils/test_logic",
  in_srcs = ["utils/test_logic.cpp"],
  in_objs = [imports.metrolib.libcore],
  out_bin = ["utils/test_logic"],
  build_tag = "test",
)

imports.rules.run_test_bin(in_bin = test_logic.promise("out_bin"))

#---------------------------------------------------------------------------------------------------

test_helpers = hancho.Config(
  suffix_pass = "{out_pass}.temp 2>&1 &&  mv {out_pass}.temp {out_pass}",
  suffix_fail = "{out_pass}.temp 2>&1 || (mv {out_pass}.temp {out_pass} && (exit 255))",
  build_tag   = "test",
)

def gen_chparams(c):
  result = []
  for key, val in c.items():
    if isinstance(val, str):
      val = f"\"{val}\""
    result.append(f"chparam -set {key} {val} {{top}};")
  return result

test_yosys_synth = test_helpers.extend(
  desc = "test yosys synth pass {rel(in_src)}",
  command = "yosys -q -p 'read_verilog {includes} -sv {rel(in_src)}; {gen_chparams(params)} synth_ice40 -json /dev/null' > {suffix_pass}",
  gen_chparams = gen_chparams,
  params = {},
  includes = ["-I."],
  out_pass = "{in_src}.yosys_synth.pass",
)

test_yosys_synth_fail = test_helpers.extend(
  desc = "test yosys synth fail {rel(in_src)}",
  command = "yosys -q -p 'read_verilog {includes} -sv {rel(in_src)}; {gen_chparams(params)} synth_ice40 -json /dev/null' > {suffix_fail}",
  gen_chparams = gen_chparams,
  params = {},
  includes = ["-I."],
  out_pass = "{in_src}.yosys_synth.pass",
)

test_yosys_parse = test_helpers.extend(
  desc = "test yosys parse {rel(in_src)}",
  command = "yosys -q -p 'read_verilog {includes} -sv {rel(in_src)};' > {suffix_pass}",
  includes = ["-I."],
  out_pass = "{in_src}.yosys_parse.pass",
)

test_verilator = test_helpers.extend(
  desc = "test verilator {rel(in_src)}",
  command = "verilator -Wno-width {includes} --lint-only {rel(in_src)} > {suffix_pass}",
  includes = ["-I."],
  out_pass = "{in_src}.verilator.pass",
)

test_icarus = test_helpers.extend(
  desc = "test icarus {rel(in_src)}",
  command = "iverilog -g2012 -Wall {includes} -o /dev/null {rel(in_src)} > {suffix_pass}",
  includes = ["-I."],
  out_pass = "{in_src}.icarus.pass",
)

test_syntax = test_helpers.extend(
  desc = "test c++ syntax {rel(in_src)}",
  command = "g++ -I. -I{repo_path} --std=gnu++2a -fsyntax-only -c {rel(in_src)} > {suffix_pass}",
  out_pass = "{in_src}.syntax.pass"
)

test_metron = test_helpers.extend(
  desc = "test metron {rel(in_src)}",
  command = "{metron_bin} -q -c {rel(in_src)} -o {rel(out_sv)} > {suffix_pass}",
  out_sv = "{swap_ext(in_src, '.sv')}",
  metron_bin = imports.metron.metron_bin,
  out_pass = "{in_src}.metron.pass"
)

test_metron_fail = test_helpers.extend(
  desc = "test metron fails {rel(in_src)}",
  command = "{metron_bin} -q -c {rel(in_src)} -o /dev/null > {suffix_fail}",
  metron_bin = imports.metron.metron_bin,
  out_pass = "{in_src}.metron.pass",
  should_fail = True
)

test_diff = test_helpers.extend(
  desc = "test diff {rel(in_src_A)} {rel(in_src_B)}",
  command = "diff {rel(in_src_A)} {rel(in_src_B)} > {suffix_pass}",
  out_pass = "{in_src_A}.diff.pass"
)

test_sv2v = test_helpers.extend(
  desc = "test sv2v {rel(in_src)}",
  command = "sv2v {includes} {rel(in_src)} -w {rel(out_v)} > {suffix_pass}",
  includes = ["-I.", "-I{repo_path}"],
  out_v = "{swap_ext(in_src, '.v')}",
  out_pass = "{in_src}.sv2v.pass",
  #debug = True
)

#---------------------------------------------------------------------------------------------------
# Test tool quirks

for file in glob.glob("tools/pass/*.sv"):
  test_icarus(in_src = file)
  test_yosys_synth(in_src = file)
  test_verilator(in_src = file)

for file in glob.glob("tools/yosys/fail/*.sv"):
  test_yosys_synth_fail(in_src = file, should_fail = True)

#---------------------------------------------------------------------------------------------------
# Test files in metron/pass and metron/fail

copy = hancho.Config(command = "cp {in_file} {out_file}")

message_copy = copy(
  in_file = "{repo_path}/tests/metron/pass/message.hex",
  out_file = "message.hex"
)

for file in glob.glob("metron/pass/*.h"):
  includes = ["-I.", "-I{repo_path}", "-I{build_path}/metron/pass"]

  test_syntax(in_src = file)
  file_sv = test_metron(in_src = file, should_fail = False).promise("out_sv")

  temp = test_sv2v(in_src = file_sv, includes = includes)
  file_v = temp.promise("out_v")

  golden = file.replace("/pass/", "/golden/").replace(".h", ".sv")
  test_diff(in_src_A = file_sv, in_src_B = golden)

  test_verilator(
    in_src = file_sv,
    in_message = message_copy.promise("out_file"),
    includes = includes
  )
  test_icarus(in_src = file_sv, includes = includes)
  test_yosys_synth(in_src = file_v, includes = includes)

for file in glob.glob("metron/fail/*.h"):
  test_syntax(in_src = file)
  test_metron_fail(in_src = file)

#---------------------------------------------------------------------------------------------------
# Lockstep tests

def test_lockstep(file, should_fail = False):
  out_sv = test_metron(in_src = file).promise("out_sv")

  includes = [
    ".",
    "{repo_path}",
    "{repo_path}/symlinks",
    "{repo_path}/symlinks/metrolib",
    "{build_path}/lockstep",
    "/usr/local/share/verilator/include",
  ]

  out_vl = imports.rules.verilator(
    name = "test lockstep",
    in_top = out_sv,
    build_tag = "test",
    includes = includes,
  )

  lockstep_obj = hancho.Task(
    command = "g++ -O3 -std=gnu++2a {join_prefix('-D', defines)} {join_prefix('-I', includes)} -c {rel(in_src)} -o {rel(out_obj)}",
    includes = includes,
    defines = [
      "MT_TOP=Module",
      "VL_TOP=V{stem}",
      "MT_HEADER={in_hdr}",
      "VL_HEADER={build_path}/lockstep/V{stem}.h",
    ],
    in_src  = "lockstep/test_lockstep.cpp",
    in_hdr  = file,
    in_deps = out_vl.promise("out_header"),
    out_obj = "{swap_ext(in_hdr, '.o')}",
    stem    = "{path.splitext(path.basename(in_hdr))[0]}",
    build_tag = "test",
  )

  lockstep_bin = hancho.Task(
    command = "g++ {in_obj} {in_lib} -o {rel(out_bin)}",
    in_obj = lockstep_obj.promise("out_obj"),
    in_lib = [out_vl.promise("out_lib"), imports.metrolib.libcore],
    out_bin = "{swap_ext(in_obj, '')}",
    build_tag = "test",
  )

  if should_fail:
    hancho.Task(
      command  = "{in_bin} > {out_pass}.temp 2>&1 || (mv {out_pass}.temp {out_pass} && (exit 255))",
      in_bin   = lockstep_bin.promise("out_bin"),
      out_pass = "{in_bin}.pass",
      should_fail = should_fail,
      build_tag = "test",
    )
  else:
    hancho.Task(
      command  = "{in_bin} > {out_pass}.temp 2>&1 && mv {out_pass}.temp {out_pass}",
      in_bin   = lockstep_bin.promise("out_bin"),
      out_pass = "{in_bin}.pass",
      should_fail = should_fail,
      build_tag = "test",
    )

for file in ["lockstep/lfsr.h", "lockstep/counter.h", "lockstep/funcs_and_tasks.h"]:
  test_lockstep(file, should_fail = False)

for file in ["lockstep/timeout_bad.h", "lockstep/lockstep_bad.h"]:
  test_lockstep(file, should_fail = True)

#---------------------------------------------------------------------------------------------------
